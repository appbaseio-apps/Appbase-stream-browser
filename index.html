<html>
<head>
	<title>My First React.js App</title>
	<script src="https://fb.me/react-0.13.3.js"></script>
	<script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
	<script src="bower_components/appbase-js/browser/appbase.js"></script>
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
	<div id="container2">
	</div>
	<script type="text/jsx">
		if (!library)
   			var library = {};
		library.json = {
			replacer: function(match, pIndent, pKey, pVal, pEnd) {
				var key = '<span class=json-key>';
				var val = '<span class=json-value>';
				var str = '<span class=json-string>';
				var r = pIndent || '';
				if (pKey)
					r = r + key + pKey.replace(/[": ]/g, '') + '</span>: ';
				if (pVal)
					r = r + (pVal[0] == '"' ? str : val) + pVal + '</span>';
				return r + (pEnd || '');
			},
			prettyPrint: function(obj) {
				var jsonLine = /^( *)("[\w]+": )?("[^"]*"|[\w.+-]*)?([,[{])?$/mg;
					return {__html: JSON.stringify(obj, null, 3)
					.replace(/&/g, '&amp;').replace(/\\"/g, '&quot;')
					.replace(/</g, '&lt;').replace(/>/g, '&gt;')
					.replace(jsonLine, library.json.replacer)};
			}
		};
		var Post = React.createClass({
		  render: function(){
		    var data = this.props.data;
		    return (
		    	<pre><code dangerouslySetInnerHTML={library.json.prettyPrint(data)}></code></pre>
		    )
		  }
		});

		var Posts = React.createClass({

		  // Render our tweets
		  render: function(){
		    console.log(this.props.posts )

		    // Build list items of single tweet components using map

		    var content;
		    if (this.props.posts.length > 0) {
		      content = this.props.posts.map(function(post) {
		        return <Post data={post} />;
		      });
		    } else {
		      content = <p>Please click on Execute!</p>;
		    }

		    // Return ul filled with our mapped tweets
		    return (
		      <ul className="posts">
		      	{content}
		      </ul>
		    )

		  }

		});
		var Feed = React.createClass({

		  	// Render the component
			render: function(){

				return (
				  <div className="feed">
				    <Posts posts={this.props.posts} />
				  </div>
				)
			}
		})
		
		var StreamBrowser = React.createClass({

			// Set the initial component state
			getInitialState: function(){
				// Set initial application state using props
				return {
					value:{username: "", password: "", query: ""},	
				  	posts: []
				};

			},
		
			addPost: function(post){
		  		// Get current application state
	    		var updated = this.state.posts;
	    		updated.unshift(post);
	    		this.setState({posts: updated});

		  	},
			executeQuery: function(e){
								// Preserve self reference

				var self = this;
				var appbaseRef = new Appbase({
				  url: 'https://scalr.api.appbase.io',
				  appname: 'testgsoc',
				  username: 'JxGrCcfHZ',
				  password: '1c46a541-98fa-404c-ad61-d41571a82e14'
				});

				appbaseRef.searchStream({
					type: 'flipkart_app',
					body: {
						"query" : {
							"match_all" : {}
						}
					}
				}).on('data', function(response) {
				    self.addPost(response);
				    // console.log("searchStream(), new match: ", response);
				}).on('error', function(error) {
				    console.log("caught a searchStream() error: ", error)
				})
				e.preventDefault();
			},

			render: function() {
				return (
					<div id ="container1">
					<div id="col1">
						<form className="queryForm" onSubmit={this.executeQuery}>
							<h2> Appbase Stream browser </h2>
					        <input type="text" placeholder="Username" />
					        <input type="text" placeholder="Passowrd" />
					        <input type="text" placeholder="Appname" />
					        <input type="text" placeholder="Type" />
					        <textarea placeholder="Query"  />
					        <button type="submit"> Execute </button>
					    </form>
					</div>
					<div id="col2">
						<Feed posts={this.state.posts}/>
					</div>
					</div>
				);
			}
		
		});
		
		React.render(
		  <StreamBrowser />,
		  document.getElementById('container2')
		);
	</script>

</body>
</html>